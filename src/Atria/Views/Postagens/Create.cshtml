@model Atria.Models.Postagem
@{
    ViewData["Title"] = "Criar Postagem";
  var comunidadeId = ViewBag.ComunidadeId;
    var grupoId = ViewBag.GrupoId;
}

@if (ViewBag.ErrorMessage != null)
{
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
 <i class="bi bi-exclamation-triangle-fill me-2"></i>
        @ViewBag.ErrorMessage
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
}

@if (TempData["SuccessMessage"] != null)
{
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        <i class="bi bi-check-circle-fill me-2"></i>
        @TempData["SuccessMessage"]
     <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
  </div>
}

<div class="page-container" style="max-width: 900px;">
    <div class="page-card">
        <div class="page-card-header">
         <h1><i class="bi bi-plus-circle me-2"></i>@ViewData["Title"]</h1>
    <p class="text-muted mb-0">Compartilhe suas ideias com a comunidade</p>
</div>
        <div class="page-card-body">
     <form asp-action="Create" method="post" id="formCriarPostagem">
     
   <!-- Seleção de Contexto -->
  <div class="mb-4">
     <h5><i class="bi bi-geo-alt me-2"></i>Onde publicar?</h5>
 <p class="text-muted small">Escolha onde sua postagem será publicada</p>
    
     <div class="row g-3">
     <!-- Comunidade -->
   <div class="col-md-6">
      <label asp-for="FKComunidade" class="form-label fw-bold">
       <i class="bi bi-people-fill me-1"></i>Comunidade (opcional)
     </label>
       <select asp-for="FKComunidade" class="form-select" asp-items="ViewBag.Comunidades">
      <option value="">-- Nenhuma Comunidade --</option>
  </select>
        <small class="form-text text-muted">Selecione uma comunidade específica</small>
   </div>
    
        <!-- Grupo -->
   <div class="col-md-6">
 <label asp-for="FKGrupo" class="form-label fw-bold">
      <i class="bi bi-bookmark-fill me-1"></i>Grupo de Estudo (opcional)
    </label>
          <select asp-for="FKGrupo" class="form-select" asp-items="ViewBag.Grupos">
       <option value="">-- Nenhum Grupo --</option>
       </select>
      <small class="form-text text-muted">Selecione um grupo de estudo</small>
 </div>
  </div>
    
     <!-- Checkbox NoForumGeral -->
     <div class="form-check form-switch mt-3">
   <input class="form-check-input" 
     type="checkbox" 
        asp-for="NoForumGeral"
   id="noForumGeralSwitch"
        checked />
     <label class="form-check-label" for="noForumGeralSwitch">
   <i class="bi bi-eye me-1"></i>Visível no Fórum Geral
   </label>
       <div class="form-text">
        Se marcado, sua postagem também aparecerá no fórum geral
     </div>
  </div>
          </div>
       
   <hr class="my-4">
    
    <!-- Título -->
   <div class="mb-4">
  <label asp-for="Titulo" class="form-label fw-bold">
       <i class="bi bi-chat-quote me-1"></i>Título
<span class="text-danger">*</span>
        </label>
     <input class="form-control form-control-lg" 
        asp-for="Titulo" 
placeholder="Digite um título chamativo para sua postagem"
           maxlength="200"
id="tituloInput"
         required />
    <span asp-validation-for="Titulo" class="text-danger"></span>
<div class="form-text">
       <i class="bi bi-info-circle me-1"></i>
  <span id="tituloContador">0</span>/200 caracteres
    </div>
          </div>

 <!-- Conteúdo -->
          <div class="mb-4">
          <label asp-for="Conteudo" class="form-label fw-bold">
             <i class="bi bi-file-text me-1"></i>Conteúdo
             <span class="text-danger">*</span>
    </label>
   <textarea class="form-control" 
 asp-for="Conteudo" 
     rows="8" 
   placeholder="Escreva o conteúdo da sua postagem...&#10;&#10;Compartilhe suas ideias, dúvidas ou conhecimentos."
 maxlength="5000"
        id="conteudoInput"
      required></textarea>
        <span asp-validation-for="Conteudo" class="text-danger"></span>
  <div class="form-text">
  <i class="bi bi-info-circle me-1"></i>
                   Seja claro e objetivo
      <span class="float-end">
      <span id="conteudoContador">0</span>/5000 caracteres
  </span>
 </div>
  </div>

   <!-- Botões -->
    <div class="d-flex gap-2 justify-content-end">
  <a class="btn btn-secondary" href="/Postagens">
   <i class="bi bi-x-circle me-2"></i>Cancelar
     </a>
        <button class="btn btn-primary btn-lg" type="submit" id="btnSubmit">
      <i class="bi bi-check-circle me-2"></i>Criar Postagem
 </button>
       </div>
    </form>
        </div>
    </div>
</div>

<!-- Prévia da Postagem -->
<div class="page-container mt-4" style="max-width: 900px; display: none;" id="previaContainer">
<div class="page-card">
        <div class="page-card-header bg-light">
   <h5 class="mb-0"><i class="bi bi-eye me-2"></i>Prévia da Postagem</h5>
 </div>
        <div class="page-card-body">
     <div class="card">
         <div class="card-body">
          <h4 class="mb-2" id="previaTitulo">Título da Postagem</h4>
<p class="text-muted mb-3" style="white-space: pre-wrap;" id="previaConteudo">Conteúdo da postagem...</p>
        <div class="d-flex gap-2">
        <span class="badge bg-primary" id="previaContexto">Fórum Geral</span>
      <span class="badge bg-secondary" id="previaVisibilidade">Visível no Geral</span>
  </div>
     </div>
      </div>
        </div>
    </div>
</div>

<style>
    #formCriarPostagem .form-control:focus,
    #formCriarPostagem .form-select:focus {
        border-color: #0d6efd;
     box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
  }
</style>

<script>
    // Contador de caracteres para título
    const tituloInput = document.getElementById('tituloInput');
    const tituloContador = document.getElementById('tituloContador');
    
    if (tituloInput) {
      tituloInput.addEventListener('input', function() {
tituloContador.textContent = this.value.length;
       atualizarPrevia();
        });
    }

    // Contador de caracteres para conteúdo
    const conteudoInput = document.getElementById('conteudoInput');
    const conteudoContador = document.getElementById('conteudoContador');
    
  if (conteudoInput) {
        conteudoInput.addEventListener('input', function() {
   conteudoContador.textContent = this.value.length;
  atualizarPrevia();
 });
    }

    // Atualizar prévia
    function atualizarPrevia() {
        const titulo = tituloInput.value || 'Título da Postagem';
        const conteudo = conteudoInput.value || 'Conteúdo da postagem...';
        const noForumGeral = document.getElementById('noForumGeralSwitch').checked;
 const comunidadeSelect = document.querySelector('select[name="FKComunidade"]');
        const grupoSelect = document.querySelector('select[name="FKGrupo"]');
 
document.getElementById('previaTitulo').textContent = titulo;
        document.getElementById('previaConteudo').textContent = conteudo;
        
     // Atualizar contexto
let contexto = 'Fórum Geral';
   
   if (comunidadeSelect && comunidadeSelect.value) {
          contexto = comunidadeSelect.options[comunidadeSelect.selectedIndex].text;
        } else if (grupoSelect && grupoSelect.value) {
    contexto = grupoSelect.options[grupoSelect.selectedIndex].text;
        }
  
   document.getElementById('previaContexto').textContent = contexto;
     document.getElementById('previaVisibilidade').textContent = noForumGeral ? 'Visível no Geral' : 'Apenas no contexto';
     
        // Mostrar/ocultar prévia
        const previaContainer = document.getElementById('previaContainer');
        if (titulo.length > 3 || conteudo.length > 10) {
  previaContainer.style.display = '';
        } else {
  previaContainer.style.display = 'none';
    }
    }

  // Event listeners
    document.getElementById('noForumGeralSwitch').addEventListener('change', atualizarPrevia);
    document.querySelector('select[name="FKComunidade"]').addEventListener('change', atualizarPrevia);
    document.querySelector('select[name="FKGrupo"]').addEventListener('change', atualizarPrevia);

    // Validação antes de enviar
    document.getElementById('formCriarPostagem').addEventListener('submit', function(e) {
        const titulo = tituloInput.value.trim();
  const conteudo = conteudoInput.value.trim();
  
        if (!titulo) {
   e.preventDefault();
   alert('Por favor, preencha o título da postagem.');
     tituloInput.focus();
        return false;
  }
        
 if (titulo.length < 3) {
            e.preventDefault();
     alert('O título deve ter pelo menos 3 caracteres.');
   tituloInput.focus();
 return false;
        }
        
        if (!conteudo) {
  e.preventDefault();
   alert('Por favor, preencha o conteúdo da postagem.');
  conteudoInput.focus();
  return false;
     }
        
   if (conteudo.length < 10) {
      e.preventDefault();
     alert('O conteúdo deve ter pelo menos 10 caracteres.');
  conteudoInput.focus();
 return false;
        }

    // Animação no botão
    const btnSubmit = document.getElementById('btnSubmit');
     btnSubmit.disabled = true;
        btnSubmit.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Criando...';
  });
</script>

@section Scripts{
    <partial name="_ValidationScriptsPartial" />
}}