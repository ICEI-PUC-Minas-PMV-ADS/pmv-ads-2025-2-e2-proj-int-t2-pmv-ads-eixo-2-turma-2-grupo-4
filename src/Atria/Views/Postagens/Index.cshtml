@model IEnumerable<Atria.Models.Postagem>
@{
    ViewData["Title"] = "Postagens";
}

<div class="page-container" style="max-width: 1200px;">
    <div class="page-card">
        <div class="page-card-header d-flex justify-content-between align-items-center">
      <h1><i class="bi bi-chat-left-text-fill me-2"></i>@ViewData["Title"]</h1>
            @if (User.Identity?.IsAuthenticated ?? false)
            {
       <a class="btn btn-light" href="/Postagens/Create">
                  <i class="bi bi-plus-circle me-1"></i>Nova Postagem
       </a>
            }
        </div>
     <div class="page-card-body">

      <!-- FILTROS -->
            <div class="postagens-filters mb-4 p-3 bg-light rounded shadow-sm">
            <div class="row g-3">
            <div class="col-md-4">
 <div class="input-group">
     <span class="input-group-text bg-white"><i class="bi bi-search"></i></span>
           <input type="text" class="form-control" id="searchInput" placeholder="Buscar postagens...">
              </div>
          </div>
      <div class="col-md-3">
   <select class="form-select" id="filterComunidade">
       <option value="">Todas as comunidades</option>
       <option value="geral">Fórum Geral</option>
  </select>
          </div>
 <div class="col-md-3">
   <select class="form-select" id="filterOrdenacao">
       <option value="recente">Mais Recentes</option>
    <option value="antigo">Mais Antigas</option>
      <option value="populares">Mais Populares</option>
  <option value="comentadas">Mais Comentadas</option>
     </select>
    </div>
           <div class="col-md-2">
       <button class="btn btn-outline-secondary w-100" id="clearFilters">
                   <i class="bi bi-x-circle me-1"></i>Limpar
         </button>
           </div>
       </div>
        </div>

         <!-- LISTA DE POSTAGENS -->
            <div class="postagens-list">
      @if (Model.Any())
            {
foreach (var p in Model)
      {
            <div class="postagem-card mb-3 border rounded shadow-sm bg-white"
    data-comunidade="@(p.FKComunidade?.ToString() ?? "geral")"
  data-data="@p.DataPostagem.Ticks"
  data-postagem-id="@p.Id">
 <div class="postagem-header p-3 border-bottom bg-light d-flex justify-content-between align-items-start">
  <div class="postagem-user-info d-flex align-items-start">
   <div class="postagem-avatar me-3">
      <i class="bi bi-person-circle text-primary" style="font-size: 2.5rem;"></i>
  </div>
        <div>
 <div class="postagem-user-name fw-bold text-dark">@(p.Usuario?.Nome ?? "Usuário")</div>
    <div class="postagem-meta text-muted small">
      <span class="postagem-date me-3">
   <i class="bi bi-clock me-1"></i>@p.DataPostagem.ToString("dd/MM/yyyy HH:mm")
  </span>
 @if (p.FKComunidade.HasValue)
        {
       <span class="postagem-comunidade">
       <i class="bi bi-people-fill me-1"></i>@(p.Comunidade?.Nome ?? "Comunidade")
    </span>
    }
  else if (p.NoForumGeral)
      {
  <span class="badge bg-info text-white">
           <i class="bi bi-globe me-1"></i>Fórum Geral
    </span>
     }
       </div>
 </div>
   </div>

 @if (User.Identity?.IsAuthenticated ?? false)
  {
       <div class="dropdown">
   <button class="btn btn-sm btn-light dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
  <i class="bi bi-three-dots-vertical"></i>
   </button>
  <ul class="dropdown-menu dropdown-menu-end">
   <li><a class="dropdown-item" href="/Postagens/Edit/@p.Id">
       <i class="bi bi-pencil me-2"></i>Editar
   </a></li>
      <li><a class="dropdown-item text-danger" href="/Postagens/Delete/@p.Id">
      <i class="bi bi-trash me-2"></i>Excluir
   </a></li>
 </ul>
   </div>
  }
 </div>

       <div class="postagem-content p-3">
 <p class="postagem-preview mb-2 text-dark">
   @(p.Conteudo.Length > 200 ? p.Conteudo.Substring(0, 200) + "..." : p.Conteudo)
        </p>
       @if (p.Conteudo.Length > 200)
   {
       <a href="/Postagens/Details/@p.Id" class="postagem-read-more text-primary text-decoration-none fw-semibold">
       Ler mais <i class="bi bi-arrow-right"></i>
    </a>
   }
    </div>

      <div class="postagem-footer p-3 border-top bg-light d-flex justify-content-between align-items-center">
   <div class="postagens-stats d-flex gap-3">
     <span class="postagem-stat text-muted" title="Visualizações">
    <i class="bi bi-eye me-1"></i>
<span class="visualizacoes-count" data-id="@p.Id">0</span>
   </span>
   <span class="postagem-stat text-muted" title="Comentários">
      <i class="bi bi-chat-dots me-1"></i>
  <span class="comentarios-count" data-id="@p.Id">0</span>
   </span>
     <span class="postagem-stat text-muted" title="Curtidas">
   <i class="bi bi-heart me-1"></i>
 <span class="curtidas-count" data-id="@p.Id">0</span>
     </span>
          </div>
     <a href="/Postagens/Details/@p.Id" class="btn btn-sm btn-outline-primary">
    <i class="bi bi-eye me-1"></i>Ver Discussão
          </a>
      </div>
  </div>
}
  }
  else
   {
     <div class="alert alert-info d-flex align-items-center" role="alert">
    <i class="bi bi-info-circle me-2 fs-4"></i>
    <div>
   Nenhuma postagem encontrada. Seja o primeiro a compartilhar algo!
   </div>
     </div>
 }
     </div>

      </div>
    </div>
</div>

@section Scripts {
<script>
    // ===== UTILITÁRIOS LOCALSTORAGE =====
    class PostagensStorage {
        static getComentarios(postagemId) {
         const key = `comentarios_${postagemId}`;
            const data = localStorage.getItem(key);
            return data ? JSON.parse(data) : [];
        }

    static getVisualizacoes(postagemId) {
            const key = `visualizacoes_${postagemId}`;
         return parseInt(localStorage.getItem(key) || '0');
        }

        static getCurtidas() {
  const data = localStorage.getItem('curtidas');
            return data ? JSON.parse(data) : {};
  }
    }

    // ===== ATUALIZAR CONTADORES =====
    function atualizarContadores() {
  document.querySelectorAll('.postagem-card').forEach(card => {
            const postagemId = card.dataset.postagemId;
            
    // Visualizações
     const vizSpan = card.querySelector('.visualizacoes-count');
        if (vizSpan) {
       vizSpan.textContent = PostagensStorage.getVisualizacoes(postagemId);
       }
         
          // Comentários
       const comSpan = card.querySelector('.comentarios-count');
            if (comSpan) {
                const comentarios = PostagensStorage.getComentarios(postagemId);
           comSpan.textContent = comentarios.length;
   // Adicionar data attribute para ordenação
                card.dataset.comentarios = comentarios.length;
     }
     
     // Curtidas
   const curtSpan = card.querySelector('.curtidas-count');
 if (curtSpan) {
    const curtidas = PostagensStorage.getCurtidas();
        const count = Object.values(curtidas).filter(Boolean).length;
       curtSpan.textContent = count;
 card.dataset.curtidas = count;
            }
 
            // Popularidade (viz + com + curtidas)
         const popularidade = 
      PostagensStorage.getVisualizacoes(postagemId) +
   (PostagensStorage.getComentarios(postagemId).length * 2) +
       (PostagensStorage.getCurtidas()[postagemId] ? 3 : 0);
       card.dataset.popularidade = popularidade;
   });
    }

    // ===== FILTROS E ORDENAÇÃO =====
  document.addEventListener('DOMContentLoaded', function () {
        const searchInput = document.getElementById('searchInput');
        const filterComunidade = document.getElementById('filterComunidade');
        const filterOrdenacao = document.getElementById('filterOrdenacao');
      const clearFilters = document.getElementById('clearFilters');
        const postagens = document.querySelectorAll('.postagem-card');

        // Atualizar contadores ao carregar
        atualizarContadores();

        function aplicarFiltros() {
       const searchTerm = searchInput.value.toLowerCase();
            const comunidadeSelecionada = filterComunidade.value;

     postagens.forEach(postagem => {
     const texto = postagem.textContent.toLowerCase();
                const comunidade = postagem.dataset.comunidade;

      const matchSearch = texto.includes(searchTerm);
                const matchComunidade = !comunidadeSelecionada || comunidade === comunidadeSelecionada;

     postagem.style.display = (matchSearch && matchComunidade) ? 'block' : 'none';
  });
        }

  function ordenarPostagens() {
            const ordem = filterOrdenacao.value;
   const container = document.querySelector('.postagens-list');
            const postagensArray = Array.from(postagens);

         postagensArray.sort((a, b) => {
   const dataA = parseInt(a.dataset.data);
      const dataB = parseInt(b.dataset.data);

                if (ordem === 'recente') return dataB - dataA;
       if (ordem === 'antigo') return dataA - dataB;
              if (ordem === 'populares') {
      return parseInt(b.dataset.popularidade || 0) - parseInt(a.dataset.popularidade || 0);
       }
         if (ordem === 'comentadas') {
              return parseInt(b.dataset.comentarios || 0) - parseInt(a.dataset.comentarios || 0);
         }
         return 0;
            });

     postagensArray.forEach(postagem => container.appendChild(postagem));
        }

        searchInput.addEventListener('input', aplicarFiltros);
        filterComunidade.addEventListener('change', aplicarFiltros);
        filterOrdenacao.addEventListener('change', ordenarPostagens);

        clearFilters.addEventListener('click', function () {
          searchInput.value = '';
            filterComunidade.value = '';
    filterOrdenacao.value = 'recente';
            aplicarFiltros();
    ordenarPostagens();
        });

        console.log('? Sistema de estatísticas carregado!');
  });
</script>
}
