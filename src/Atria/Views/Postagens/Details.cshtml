@model Atria.Models.Postagem
@{
    ViewData["Title"] = "Detalhes da Postagem";
  var totalComentarios = Model.Comentarios?.Count ?? 0;
}

@if (TempData["SuccessMessage"] != null)
{
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        <i class="bi bi-check-circle-fill me-2"></i>
        @TempData["SuccessMessage"]
  <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
}

@if (TempData["ErrorMessage"] != null)
{
 <div class="alert alert-danger alert-dismissible fade show" role="alert">
        <i class="bi bi-exclamation-triangle-fill me-2"></i>
        @TempData["ErrorMessage"]
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
}

<div class="page-container" style="max-width: 1000px;">
    <div class="page-card">
        <div class="page-card-header d-flex justify-content-between align-items-center">
            <h1><i class="bi bi-chat-left-text-fill me-2"></i>@ViewData["Title"]</h1>
       <a class="btn btn-light" href="/Postagens">
   <i class="bi bi-arrow-left me-1"></i>Voltar
            </a>
     </div>
     <div class="page-card-body">
          <!-- POSTAGEM PRINCIPAL -->
          <div class="postagem-details-card mb-4 border rounded">
    <div class="postagem-header p-3 border-bottom bg-light">
   <div class="d-flex align-items-start">
      <div class="postagem-avatar me-3">
          <i class="bi bi-person-circle text-primary" style="font-size: 3rem;"></i>
</div>
   <div class="flex-grow-1">
        <div class="postagem-user-name fw-bold fs-5 text-dark">@(Model.Usuario?.Nome ?? "Usuário")</div>
      <div class="postagem-meta text-muted small">
           <span class="me-3">
        <i class="bi bi-clock me-1"></i>@Model.DataPostagem.ToString("dd/MM/yyyy HH:mm")
    </span>
                @if (Model.FKComunidade.HasValue)
       {
   <span class="postagem-comunidade">
   <i class="bi bi-people-fill me-1"></i>@(Model.Comunidade?.Nome ?? "Comunidade")
    </span>
      }
        else if (Model.FKGrupo.HasValue)
                {
  <span class="postagem-grupo">
  <i class="bi bi-bookmark-fill me-1"></i>@(Model.GrupoEstudo?.Nome ?? "Grupo")
     </span>
 }
    else if (Model.NoForumGeral)
 {
   <span class="badge bg-info text-white">
         <i class="bi bi-globe me-1"></i>Fórum Geral
         </span>
    }
          </div>
       </div>

            @if (User.Identity?.IsAuthenticated ?? false)
    {
     var userIdClaim = User.FindFirst("http://schemas.xmlsoap.org/ws/2005/05/identity/claims/nameidentifier");
    if (userIdClaim != null && int.TryParse(userIdClaim.Value, out var userId) && Model.FKUsuario == userId)
      {
   <div class="dropdown">
        <button class="btn btn-sm btn-light dropdown-toggle" type="button" data-bs-toggle="dropdown">
     <i class="bi bi-three-dots-vertical"></i>
     </button>
     <ul class="dropdown-menu dropdown-menu-end">
    <li><a class="dropdown-item" href="/Postagens/Edit/@Model.Id">
            <i class="bi bi-pencil me-2"></i>Editar
          </a></li>
        <li><a class="dropdown-item text-danger" href="/Postagens/Delete/@Model.Id">
        <i class="bi bi-trash me-2"></i>Excluir
   </a></li>
      </ul>
 </div>
}
   }
        </div>
      </div>

   <div class="postagem-content-full p-4 bg-white">
   @if (!string.IsNullOrEmpty(Model.Titulo))
{
        <h2 class="postagem-titulo-detalhes fw-bold mb-3">@Model.Titulo</h2>
 }
     @if (!string.IsNullOrEmpty(Model.Conteudo))
      {
     <p class="mb-0 text-dark" style="white-space: pre-wrap; line-height: 1.7;">@Model.Conteudo</p>
     }
     else
     {
   <p class="mb-0 text-muted"><em>Esta postagem não possui conteúdo.</em></p>
 }
 </div>

         <!-- FOOTER COM ESTATÍSTICAS -->
                <div class="postagem-footer p-3 border-top bg-light d-flex justify-content-between align-items-center">
  <div class="postagem-stats d-flex gap-4">
    <!-- Comentários -->
  <span class="postagem-stat text-muted" title="Comentários">
      <i class="bi bi-chat-dots me-1"></i>
   <span class="fw-semibold">@totalComentarios</span> comentário@(totalComentarios != 1 ? "s" : "")
 </span>
      </div>
        <div class="text-muted small">
        <i class="bi bi-info-circle me-1"></i>
          Postado em @Model.DataPostagem.ToString("dd/MM/yyyy 'às' HH:mm")
   </div>
   </div>
            </div>

       <!-- SEÇÃO DE COMENTÁRIOS -->
 <div class="comentarios-section">
       <h3 class="mb-3">
<i class="bi bi-chat-dots me-2"></i>
Comentários (@totalComentarios)
        </h3>

     @if (User.Identity?.IsAuthenticated ?? false)
      {
   <!-- FORMULÁRIO PARA NOVO COMENTÁRIO -->
<div class="comentario-form-card mb-4 p-3 border rounded bg-light">
        <form asp-controller="Comentario" asp-action="Create" method="post">
      <input type="hidden" name="FKPostagem" value="@Model.Id" />
      <div class="mb-3">
   <label for="Conteudo" class="form-label fw-semibold">Deixe seu comentário:</label>
       <textarea class="form-control" id="comentario-input" name="Conteudo" rows="3"
    placeholder="Compartilhe sua opinião, faça uma pergunta ou contribua para a discussão..."
   maxlength="1000" required></textarea>
          <div class="form-text">
        <span id="char-count">0</span>/1000 caracteres
      </div>
     </div>
    <button type="submit" class="btn btn-primary">
      <i class="bi bi-send me-1"></i>Comentar
 </button>
 </form>
    </div>
       }
    else
    {
     <div class="alert alert-info">
     <i class="bi bi-info-circle me-2"></i>
     <a href="/Account/Login">Faça login</a> para comentar nesta postagem.
 </div>
       }

 <!-- LISTA DE COMENTÁRIOS -->
   <div class="comentarios-list">
   @if (totalComentarios > 0)
        {
     foreach (var comentario in Model.Comentarios!.OrderByDescending(c => c.DataComentario))
           {
   <div class="comentario-card mb-3 p-3 border rounded bg-white">
          <div class="d-flex align-items-start">
 <div class="comentario-avatar me-3">
    <i class="bi bi-person-circle text-secondary" style="font-size: 2rem;"></i>
   </div>
    <div class="flex-grow-1">
     <div class="d-flex justify-content-between align-items-start mb-2">
        <div>
   <div class="comentario-user-name fw-semibold text-dark">
       @(comentario.Usuario?.Nome ?? "Usuário")
       </div>
     <div class="comentario-date text-muted small">
     <i class="bi bi-clock me-1"></i>
    @comentario.DataComentario.ToString("dd/MM/yyyy HH:mm")
       </div>
    </div>
           @if (User.Identity?.IsAuthenticated ?? false)
 {
    var userIdClaim = User.FindFirst("http://schemas.xmlsoap.org/ws/2005/05/identity/claims/nameidentifier");
      if (userIdClaim != null && int.TryParse(userIdClaim.Value, out var userId) && comentario.FKUsuario == userId)
   {
         <div class="dropdown">
      <button class="btn btn-sm btn-light dropdown-toggle" type="button" data-bs-toggle="dropdown">
      <i class="bi bi-three-dots-vertical"></i>
    </button>
    <ul class="dropdown-menu dropdown-menu-end">
   <li>
    <a class="dropdown-item text-danger" href="/Comentario/Delete/@comentario.Id">
       <i class="bi bi-trash me-2"></i>Excluir
          </a>
    </li>
     </ul>
   </div>
    }
         }
       </div>
    <div class="comentario-content mt-2">
        <p class="mb-0 text-dark" style="white-space: pre-wrap;">@comentario.Conteudo</p>
    </div>
 </div>
    </div>
           </div>
}
         }
    else
      {
      <div class="alert alert-secondary">
   <i class="bi bi-chat-dots me-2"></i>
    Nenhum comentário ainda. Seja o primeiro a comentar!
   </div>
        }
    </div>
</div>

<style>
    /* ===== ANIMAÇÕES E TRANSIÇÕES ===== */
    .page-card {
        animation: fadeIn 0.4s ease;
    }
    
    @@keyframes fadeIn {
   from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    /* ===== HOVER EFFECTS ===== */
    .hover-card {
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    
    .hover-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(0,0,0,0.12);
    }
    
    /* ===== BOTÕES ===== */
.btn {
     transition: all 0.2s ease;
    }
  
    .btn:hover {
 transform: translateY(-2px);
   box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    
    /* ===== COMENTÁRIOS ===== */
    .comentario-card {
   transition: transform 0.2s ease, box-shadow 0.2s ease;
  }
    
    .comentario-card:hover {
        transform: translateX(4px);
 box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }
    
    /* ===== TEXTAREA FOCUS ===== */
    #comentario-input:focus {
        border-color: #0d6efd;
        box-shadow: 0 0 0 0.2rem rgba(13,110,253,.25);
        transform: scale(1.01);
  transition: all 0.2s ease;
}
    
    /* ===== AVATAR ===== */
    .postagem-avatar i, .comentario-avatar i {
        transition: transform 0.2s ease;
    }
    
    .hover-card:hover .postagem-avatar i,
    .comentario-card:hover .comentario-avatar i {
 transform: scale(1.1);
  }
    
    /* ===== STATS ===== */
  .postagem-stat {
 transition: color 0.2s ease, transform 0.2s ease;
    }
    
    .postagem-stat:hover {
     color: #0d6efd !important;
        transform: scale(1.05);
    }
    
    /* ===== BADGES ===== */
    .badge {
        transition: transform 0.2s ease;
    }
    
    .badge:hover {
        transform: scale(1.05);
    }
    
    /* ===== DROPDOWN ===== */
    .dropdown-toggle {
transition: all 0.2s ease;
    }
    
    .dropdown-toggle:hover {
background-color: #e9ecef;
      transform: scale(1.05);
    }
    
  /* ===== RESPONSIVO ===== */
  @@media (max-width: 768px) {
 .btn:hover {
transform: none;
        }
      
        .card:hover {
   transform: none;
    }
    }
</style>

<script>
    // Contador de caracteres
    const textarea = document.getElementById('comentario-input');
    const charCount = document.getElementById('char-count');
    
    if (textarea && charCount) {
        textarea.addEventListener('input', function() {
     charCount.textContent = this.value.length;
});
    }
</script>