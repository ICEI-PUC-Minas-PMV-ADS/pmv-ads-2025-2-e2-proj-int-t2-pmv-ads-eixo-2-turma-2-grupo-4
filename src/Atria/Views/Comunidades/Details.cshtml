@model Atria.Models.Comunidade
@{
    ViewData["Title"] = Model.Nome;
    // Tenta pegar o ID do usuário logado para mostrar opções de edição/exclusão nos posts dele
    var userIdClaim = User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier);
    string currentUserId = userIdClaim?.Value ?? "";
}

<div class="page-container">

    <div class="page-card mb-4">
        <div class="page-card-body p-4">
            <div class="d-flex justify-content-between align-items-start">
                <div>
                    <h1 class="fw-bold text-dark mb-2">@Model.Nome</h1>
                    <p class="text-secondary mb-3">@Model.Descricao</p>
                    <div class="text-muted small">
                        <i class="bi bi-calendar3 me-1"></i> Criada em @Model.DataCriacao.ToString("dd/MM/yyyy")
                        <span class="mx-2">•</span>
                        <i class="bi bi-people-fill me-1"></i> @(Model.Postagens?.Count ?? 0) postagens
                    </div>
                </div>
                <a asp-action="Index" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-left"></i> Voltar
                </a>
            </div>
        </div>
    </div>

    <div class="d-flex gap-2 mb-3">
        <button class="btn btn-primary flex-grow-1 fw-bold" id="btn-tab-posts" onclick="switchTab('posts')">
            <i class="bi bi-chat-square-text-fill me-2"></i>Postagens
        </button>
        <button class="btn btn-dark flex-grow-1 fw-bold opacity-75" id="btn-tab-grupos" onclick="switchTab('grupos')">
            <i class="bi bi-grid-fill me-2"></i>Grupos de Estudo
        </button>
    </div>

    <div id="tab-posts" class="animate-fade">
        <div class="page-card bg-light border-0">

            <div class="page-card-header d-flex justify-content-between align-items-center bg-dark text-white rounded-top">
                <h4 class="m-0 fs-5"><i class="bi bi-chat-left-text me-2"></i>Postagens da Comunidade</h4>
                <a asp-controller="Postagens" asp-action="Create" asp-route-comunidadeId="@Model.Id" class="btn btn-light text-dark fw-bold btn-sm">
                    <i class="bi bi-plus-circle me-1"></i>Nova Postagem
                </a>
            </div>

            <div class="p-3">
                @if (Model.Postagens != null && Model.Postagens.Any())
                {
                <div class="row g-3">
                    @foreach (var item in Model.Postagens)
                        {
                    <div class="col-12">
                        <div class="card shadow-sm border-0 h-100">
                            <div class="card-body">
                                <div class="d-flex justify-content-between mb-2">
                                    <div class="d-flex align-items-center">
                                        <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-2" style="width: 40px; height: 40px;">
                                            @(item.Usuario?.Nome?.Substring(0,1).ToUpper() ?? "?")
                                        </div>
                                        <div>
                                            <div class="fw-bold text-dark">@item.Usuario?.Nome</div>
                                            <small class="text-muted">@item.DataPostagem.ToLocalTime().ToString("dd/MM/yyyy HH:mm")</small>
                                        </div>
                                    </div>

                                    @if (currentUserId == item.FKUsuario.ToString())
                                            {
                                    <div class="dropdown">
                                        <button class="btn btn-link text-muted p-0" data-bs-toggle="dropdown">
                                            <i class="bi bi-three-dots-vertical"></i>
                                        </button>
                                        <ul class="dropdown-menu dropdown-menu-end">
                                            <li><a class="dropdown-item" asp-controller="Postagens" asp-action="Edit" asp-route-id="@item.Id">Editar</a></li>
                                            <li><a class="dropdown-item text-danger" asp-controller="Postagens" asp-action="Delete" asp-route-id="@item.Id">Excluir</a></li>
                                        </ul>
                                    </div>
                                            }
                                </div>

                                <a asp-controller="Postagens" asp-action="Details" asp-route-id="@item.Id" asp-route-returnUrl="@($"/Comunidades/Details/{Model.Id}")" class="text-decoration-none">
                                    <h5 class="card-title text-primary fw-bold mb-2">@item.Titulo</h5>
                                    <p class="card-text text-secondary text-truncate">@item.Conteudo</p>
                                </a>
                            </div>
                            <div class="card-footer bg-white border-top-0 pt-0 d-flex gap-3">
                                <span class="text-muted small"><i class="bi bi-chat-dots me-1"></i> @(item.Comentarios?.Count ?? 0) comentários</span>
                                <a asp-controller="Postagens" asp-action="Details" asp-route-id="@item.Id" asp-route-returnUrl="@($"/Comunidades/Details/{Model.Id}")" class="text-muted small text-decoration-none">
                                    <i class="bi bi-eye me-1"></i> Ver detalhes
                                </a>
                            </div>
                        </div>
                    </div>
                        }
                </div>
                }
                else
                {
                <div class="alert alert-info d-flex align-items-center" role="alert">
                    <i class="bi bi-info-circle-fill fs-4 me-3"></i>
                    <div>
                        <strong>Nenhuma postagem encontrada.</strong>
                        <br>Seja o primeiro a compartilhar conhecimento nesta comunidade!
                    </div>
                </div>
                }
            </div>
        </div>
    </div>

    <div id="tab-grupos" class="animate-fade" style="display: none;">
        <div class="page-card">
            <div class="page-card-header d-flex justify-content-between align-items-center">
                <h4 class="m-0 fs-5"><i class="bi bi-grid-fill me-2"></i>Grupos de Estudo</h4>
                <a asp-controller="GruposEstudo" asp-action="Create" asp-route-comunidadeId="@Model.Id" class="btn btn-success btn-sm text-white fw-bold">
                    <i class="bi bi-plus-lg me-1"></i>Novo Grupo
                </a>
            </div>

            <div class="page-card-body p-3">
                @if (Model.GruposEstudo != null && Model.GruposEstudo.Any())
                {
                <div class="list-group">
                    @foreach (var grupo in Model.GruposEstudo)
                        {
                    <a href="/GruposEstudo/Details/@grupo.Id" class="list-group-item list-group-item-action p-3 d-flex align-items-center justify-content-between">
                        <div class="d-flex align-items-center">
                            <div class="bg-light rounded p-3 me-3 text-muted">
                                <i class="bi bi-hash fs-4"></i>
                            </div>
                            <div>
                                <h5 class="mb-1 text-dark fw-bold">@grupo.Nome</h5>
                                <p class="mb-0 text-muted small">@grupo.Descricao</p>
                            </div>
                        </div>
                        <i class="bi bi-chevron-right text-secondary"></i>
                    </a>
                        }
                </div>
                }
                else
                {
                <div class="text-center py-5 text-muted">
                    <i class="bi bi-collection fs-1"></i>
                    <p class="mt-2">Nenhum grupo de estudo criado ainda.</p>
                </div>
                }
            </div>
        </div>
    </div>

</div>

<script>
    function switchTab(tabName) {
        // Esconde tudo
        document.getElementById('tab-posts').style.display = 'none';
        document.getElementById('tab-grupos').style.display = 'none';

        // Reseta botões para estilo padrão (escuro/opaco)
        document.getElementById('btn-tab-posts').className = 'btn btn-dark flex-grow-1 fw-bold opacity-75';
        document.getElementById('btn-tab-grupos').className = 'btn btn-dark flex-grow-1 fw-bold opacity-75';

        // Ativa a aba clicada (Estilo Azul/Primary)
        if (tabName === 'posts') {
            document.getElementById('tab-posts').style.display = 'block';
            document.getElementById('btn-tab-posts').className = 'btn btn-primary flex-grow-1 fw-bold';
        } else {
            document.getElementById('tab-grupos').style.display = 'block';
            document.getElementById('btn-tab-grupos').className = 'btn btn-primary flex-grow-1 fw-bold';
        }
    }
</script>

<style>
    /* Animação suave ao trocar de aba */
    .animate-fade {
        animation: fadeIn 0.3s ease-in-out;
    }

    @@keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(5px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
</style>